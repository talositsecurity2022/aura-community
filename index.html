<!DOCTYPE html>
<html lang="en" data-theme="default">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura - Your Personal Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root, [data-theme="default"] { --bg-color: #F8F7F4; --main-card-bg: rgba(255, 255, 255, 0.7); --agent-bubble-bg: #f3f4f6; --user-bubble-bg: #dbeafe; --accent-color: #3b82f6; --text-primary: #1f2937; --text-secondary: #4b5563; --border-color: rgba(229, 231, 235, 0.8); }
        [data-theme="sunrise"] { --bg-gradient: linear-gradient(-45deg, #fff2f0, #fffbf5, #ffedd5, #fffbf5); --main-card-bg: rgba(255, 253, 250, 0.7); --agent-bubble-bg: #fef3c7; --user-bubble-bg: #ffedd5; --accent-color: #f97316; --text-primary: #472c1a; --text-secondary: #785a49; --border-color: rgba(253, 230, 208, 0.8); }
        [data-theme="forest"] { --bg-gradient: linear-gradient(-45deg, #f0fdf4, #f0f5f3, #dcfce7, #f0f5f3); --main-card-bg: rgba(248, 252, 250, 0.7); --agent-bubble-bg: #dcfce7; --user-bubble-bg: #cffafe; --accent-color: #0d9488; --text-primary: #1e3a35; --text-secondary: #4a635e; --border-color: rgba(216, 229, 225, 0.8); }
        [data-theme="twilight"] { --bg-gradient: linear-gradient(-45deg, #f5f3ff, #eef2ff, #faf5ff, #eef2ff); --main-card-bg: rgba(245, 243, 255, 0.7); --agent-bubble-bg: #e9d5ff; --user-bubble-bg: #dbeafe; --accent-color: #8b5cf6; --text-primary: #2e1065; --text-secondary: #581c87; --border-color: rgba(221, 214, 254, 0.8); }
        body { font-family: 'Inter', sans-serif; background: var(--bg-gradient, #F8F7F4); background-size: 400% 400%; animation: gradientAnimation 20s ease infinite; color: var(--text-primary); }
        .main-card-bg { background-color: var(--main-card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .agent-bubble { background-color: var(--agent-bubble-bg); border-bottom-left-radius: 0.25rem; }
        .user-bubble { background-color: var(--user-bubble-bg); border-bottom-right-radius: 0.25rem; }
        .accent-bg { background-color: var(--accent-color); }
        .accent-text { color: var(--accent-color); }
        .border-color { border-color: var(--border-color); }
        .text-secondary { color: var(--text-secondary); }
        .chat-container { scroll-behavior: smooth; }
        .chat-bubble { animation: fadeIn 0.5s ease-in-out, slideIn 0.5s ease-in-out; max-width: 85%; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(10px); } to { transform: translateY(0); } }
        @keyframes gradientAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .focus-button:hover, .theme-button:hover, .persona-button:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -4px rgba(0,0,0,0.05); }
        .onboarding-step { display: none; }
        .onboarding-step.active { display: block; animation: fadeIn 0.5s; }
        .audio-icon { cursor: pointer; transition: color 0.2s ease-in-out; }
        .audio-icon:hover { color: var(--accent-color); }
        .audio-icon.playing { color: var(--accent-color); }
        .resource-category-button.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
    </style>
</head>
<body>
    <div id="auth-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full shadow-xl">
            <h2 id="auth-title" class="text-2xl font-bold mb-6 text-center">Welcome to Aura</h2>
            <form id="auth-form">
                <input type="email" id="auth-email" class="w-full p-3 border border-gray-300 rounded-md mb-4" placeholder="Email Address" required>
                <input type="password" id="auth-password" class="w-full p-3 border border-gray-300 rounded-md mb-6" placeholder="Password" required>
                <button type="submit" id="auth-submit-button" class="w-full accent-bg text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition">Login</button>
            </form>
            <p id="auth-error" class="text-red-500 text-sm mt-4 text-center h-4"></p>
            <div class="mt-4 text-center">
                <button id="auth-toggle-button" class="text-sm text-blue-600 hover:underline">Need an account? Sign up</button>
            </div>
        </div>
    </div>
    <div id="main-app-container" class="hidden min-h-screen flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8">
        <div class="w-full max-w-2xl h-[85vh] md:h-[80vh] flex flex-col rounded-3xl shadow-2xl overflow-hidden main-card-bg">
            <header class="p-4 border-b border-color text-center flex-shrink-0 flex justify-between items-center">
                 <button id="settings-button" class="text-secondary p-2 rounded-full hover:bg-gray-100/50 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
                <div class="text-center">
                    <h1 class="text-2xl font-bold tracking-tight" data-i18n-key="auraTitle">Aura</h1>
                    <p class="text-sm text-secondary" data-i18n-key="auraSubtitle">Your personal guide to a calmer day.</p>
                </div>
                <button id="help-button" class="text-xs flex items-center gap-1 bg-white border border-color text-secondary font-semibold py-1 px-3 rounded-full hover:bg-gray-100 transition">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>
                    <span data-i18n-key="supportButton">Support</span>
                </button>
            </header>
            <div id="chat-container" class="flex-1 p-6 space-y-6 overflow-y-auto"></div>
            <div id="input-area" class="p-4 border-t border-color bg-white/50 flex-shrink-0">
                 <div id="focus-choices" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
                 <div id="text-input-container" class="hidden">
                    <form id="chat-form" class="flex items-center gap-3">
                        <input type="text" id="chat-input" class="w-full p-3 bg-gray-100 rounded-full border-transparent focus:ring-2 focus:outline-none transition" data-i18n-placeholder="chatPlaceholder">
                        <button type="submit" id="submit-button" class="accent-bg text-white rounded-full p-3 hover:opacity-90 transition shadow-md">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-60 z-40"></div>
    <div id="settings-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 z-50"><div class="bg-white rounded-2xl p-6 md:p-8 max-w-lg w-full shadow-xl"><h2 data-i18n-key="settingsTitle" class="text-2xl font-bold mb-4">Settings</h2><h3 data-i18n-key="convoStyleTitle" class="font-semibold text-lg mb-2">Conversation Style</h3><div id="settings-persona-selector" class="space-y-3"></div><div class="mt-6"><h3 data-i18n-key="themeTitle" class="font-semibold text-lg mb-2">Color Theme</h3><div id="settings-theme-selector" class="grid grid-cols-4 gap-4"></div></div><div class="mt-6"><h3 data-i18n-key="audioTitle" class="font-semibold text-lg mb-2">Audio</h3><label for="audio-toggle-settings" class="flex items-center justify-between p-3 border rounded-lg cursor-pointer border-color"><span data-i18n-key="enableVoiceLabel">Enable Voice Responses</span><div class="relative"><input id="audio-toggle-settings" type="checkbox" class="sr-only peer" /><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></div></label></div><div class="mt-8 pt-6 border-t border-color"><h3 data-i18n-key="startOverTitle" class="font-semibold text-lg mb-2">Start Over</h3><p data-i18n-key="startOverSubtitle" class="text-sm text-secondary mb-3">This will clear your saved settings and restart the app, showing the intro screen again.</p><button id="reset-app-button" class="w-full bg-red-100 text-red-700 font-bold py-2 px-4 rounded-lg hover:bg-red-200 transition" data-i18n-key="resetButton">Reset & Start Over</button></div><button class="close-modal-button mt-8 w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition" data-i18n-key="closeButton">Close</button></div></div>
    <div id="help-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 md:p-8 max-w-2xl w-full h-[90vh] flex flex-col shadow-xl">
            <h2 data-i18n-key="resourceHubTitle" class="text-2xl font-bold mb-2">Resource Hub</h2>
            <p data-i18n-key="resourceHubSubtitle" class="text-secondary mb-6">Find trusted local services or ask Aura to search for specific help near you.</p>
            <div class="border-b border-color mb-4"><nav class="-mb-px flex space-x-6" id="resource-tabs"><button data-tab="directory" class="resource-category-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm active border-blue-500" data-i18n-key="directoryTab">Trusted Directory</button><button data-tab="search" class="resource-category-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent" data-i18n-key="aiSearchTab">AI Assistant Search</button></nav></div>
            <div id="directory-content" class="resource-tab-content flex-1 overflow-y-auto space-y-4"><p class="text-sm text-secondary" data-i18n-key="directoryDescription">These are vetted national services for your region. For immediate danger, please call your local emergency number.</p><div id="modal-service-list" class="space-y-4"></div></div>
            <div id="search-content" class="resource-tab-content hidden flex-1 flex-col overflow-y-auto"><div class="flex-shrink-0 mb-4"><p class="text-sm text-secondary mb-2" data-i18n-key="aiSearchDescription">Describe the help you're looking for. Be as specific as you like (e.g., "low-cost youth counseling in Melbourne").</p><div class="flex gap-2"><input type="text" id="ai-search-input" class="w-full p-2 border border-color rounded-md" data-i18n-placeholder="aiSearchPlaceholder"><button id="ai-search-button" class="accent-bg text-white font-semibold px-4 py-2 rounded-md" data-i18n-key="searchButton">Search</button></div></div><div id="ai-search-results" class="flex-1 overflow-y-auto bg-gray-50 p-4 rounded-lg"><p class="text-secondary text-center" data-i18n-key="aiSearchInitial">Your search results will appear here.</p></div></div>
            <button class="close-modal-button mt-6 w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition flex-shrink-0" data-i18n-key="closeButton">Close</button>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 1. DEFINE ALL STATE & CONSTANTS ---
    const mainAppContainer = document.getElementById('main-app-container');
    const onboardingContainer = document.getElementById('onboarding-container');
    const authModal = document.getElementById('auth-modal');
    
    // --- IMPORTANT: UPDATE THIS URL ---
    // After you deploy the "aura-plus-backend" service, you will get a public URL from Northflank. 
    // You MUST paste that URL here.
    const BACKEND_URL = "https://YOUR_AURA_PLUS_BACKEND_URL_HERE.northflank.app";

    let authToken = localStorage.getItem('aura_auth_token');
    let apiKey = "";
    
    // All other state variables and helper functions are the same
    // ...

    // --- 3. DEFINE MAIN APPLICATION LOGIC ---
    
    async function initializeChat() {
        // ... (The entire initializeChat function, unchanged from the last correct version) ...
    }

    function initializeMainApp() {
        // ... (The entire initializeMainApp function, unchanged from the last correct version) ...
    }

    // --- 4. THE NEW, STABLE STARTUP SEQUENCE ---
    async function startApplication() {
        if (authToken) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/key`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('aura_auth_token');
                    authModal.classList.remove('hidden');
                    return;
                }
                if (!response.ok) throw new Error('Could not verify session.');
                
                const data = await response.json();
                apiKey = data.apiKey;
                initializeMainApp();

            } catch (error) {
                console.error("CRITICAL STARTUP ERROR:", error);
                document.body.innerHTML = `<div class="text-center p-8"><h1>Connection Error</h1><p>Could not connect to Aura's core services. Please try again later.</p></div>`;
            }
        } else {
            authModal.classList.remove('hidden');
        }
    }
    
    // --- AUTHENTICATION LOGIC ---
    const authForm = document.getElementById('auth-form');
    const authEmail = document.getElementById('auth-email');
    const authPassword = document.getElementById('auth-password');
    const authSubmitButton = document.getElementById('auth-submit-button');
    const authToggleButton = document.getElementById('auth-toggle-button');
    const authError = document.getElementById('auth-error');
    const authTitle = document.getElementById('auth-title');
    let isLogin = true;

    authToggleButton.addEventListener('click', () => {
        isLogin = !isLogin;
        authTitle.textContent = isLogin ? "Login to Aura" : "Sign Up for Aura";
        authSubmitButton.textContent = isLogin ? "Login" : "Sign Up";
        authToggleButton.textContent = isLogin ? "Need an account? Sign up" : "Have an account? Login";
        authError.textContent = "";
    });

    authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = authEmail.value;
        const password = authPassword.value;
        const endpoint = isLogin ? '/api/auth/login' : '/api/auth/signup';
        authError.textContent = "";
        authSubmitButton.disabled = true;

        try {
            const response = await fetch(BACKEND_URL + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            if (!response.ok) {
                const data = await response.json().catch(()=>({}));
                throw new Error(data.error || (isLogin ? "Invalid credentials." : "Could not sign up."));
            }
            
            if (isLogin) {
                const data = await response.json();
                authToken = data.token;
                localStorage.setItem('aura_auth_token', authToken);
                authModal.classList.add('hidden');
                startApplication();
            } else {
                alert("Signup successful! Please log in.");
                isLogin = true;
                authTitle.textContent = "Login to Aura";
                authSubmitButton.textContent = "Login";
                authToggleButton.textContent = "Need an account? Sign up";
                authPassword.value = "";
            }
        } catch (error) {
            authError.textContent = error.message;
        } finally {
            authSubmitButton.disabled = false;
        }
    });
    
    startApplication();
});
</script>
</body>
</html>
